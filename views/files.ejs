<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>File Explorer</title>
    <style>
        body {
            font-family: sans-serif;
        }
        .breadcrumb a {
            text-decoration: none;
            color: blue;
        }
        .breadcrumb span {
            margin: 0 5px;
        }
        .folder-item, .file-item {
            display: flex;
            align-items: center;
            margin-bottom: 5px;
            padding: 5px;
            border: 1px solid #eee;
        }
        .item-name {
            flex-grow: 1;
        }
        .item-buttons button {
            margin-left: 5px;
        }
    </style>
</head>
<body>
    <h1>File Explorer</h1>

    <div class="breadcrumb">
        Current Path:
        <a href="/files">Root</a>
        <% if (currentPath && currentPath.length > 0) { %>
            <% currentPath.forEach(pathItem => { %>
                <% if (pathItem.id !== null) { %>
                    <span>&gt;</span>
                    <a href="/folders/<%= pathItem.id %>"><%= pathItem.name %></a>
                <% } %>
            <% }); %>
        <% } %>
    </div>

    <div>
        <button id="createFolderBtn">Create Folder</button>
        <a href="/upload<%= currentFolderId !== null ? '?folderId=' + currentFolderId : '' %>">
            <button>Upload File</button>
        </a>
    </div>

    <h2>Folders</h2>
    <div id="folderList">
        <% if (folders && folders.length > 0) { %>
            <ul>
                <% folders.forEach(folder => { %>
                    <li class="folder-item">
                        <span class="item-name"><%= folder.name %></span>
                        <div class="item-buttons">
                            <button onclick="openFolder(<%= folder.folder_id %>)">Open</button>
                            <button onclick="editFolder(<%= folder.folder_id %>, '<%= folder.name %>')">Edit</button>
                            <button onclick="deleteFolder(<%= folder.folder_id %>)">Delete</button>
                        </div>
                    </li>
                <% }); %>
            </ul>
        <% } else { %>
            <p>No subfolders here.</p>
        <% } %>
    </div>

    <h2>Files</h2>
    <div id="fileList">
        <% if (files && files.length > 0) { %>
            <ul>
                <% files.forEach(file => { %>
                    <li class="file-item">
                        <span class="item-name"><%= file.name %></span>
                        <div class="item-buttons">
                            <a href="<%= file.url.replace('/upload/', '/upload/fl_attachment/') %>" target="_blank">
                                <button>Download</button>
                            </a>
                            <button onclick="deleteFile(<%= file.file_id %>)">Delete</button>
                        </div>
                    </li>
                <% }); %>
            </ul>
        <% } else { %>
            <p>No files here.</p>
        <% } %>
    </div>

    <script>
        document.getElementById('createFolderBtn').addEventListener('click', () => {
            const folderName = prompt('Enter the name of the new folder:');
            if (folderName) {
                const parentId = '<%= currentFolderId %>'; // Get the current folder ID
                fetch('/folders', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `name=${encodeURIComponent(folderName)}&parentId=${encodeURIComponent(parentId)}`,
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload(); // Reload the page to see the new folder
                    } else {
                        alert('Failed to create folder.');
                        console.error('Failed to create folder:', response);
                    }
                });
            }
        });

        function openFolder(folderId) {
            window.location.href = `/folders/${folderId}`;
        }

        function editFolder(folderId, currentName) {
            const newName = prompt('Enter the new name for the folder:', currentName);
            if (newName && newName !== currentName) {
                fetch(`/folders/${folderId}/edit`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `name=${encodeURIComponent(newName)}`,
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to edit folder.');
                        console.error('Failed to edit folder:', response);
                    }
                });
            }
        }

        function deleteFolder(folderId) {
            if (confirm('Are you sure you want to delete this folder and all its contents?')) {
                fetch(`/folders/${folderId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete folder.');
                        console.error('Failed to delete folder:', response);
                    }
                });
            }
        }

        function deleteFile(fileId) {
            if (confirm('Are you sure you want to delete this file?')) {
                fetch(`/files/${fileId}/delete`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                })
                .then(response => {
                    if (response.ok) {
                        window.location.reload();
                    } else {
                        alert('Failed to delete file.');
                        console.error('Failed to delete file:', response);
                    }
                });
            }
        }
    </script>
</body>
</html>